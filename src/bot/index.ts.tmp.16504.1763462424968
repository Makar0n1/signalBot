import dotenv from "dotenv";
dotenv.config();

import { Context, Scenes, Telegraf, session } from "telegraf";
import mongoose from "mongoose";

import messageHandler from "./handlers/messageHandler.js";
import commandHandler from "./handlers/commandHandler.js";
import actionHandler from "./handlers/actionHandler.js";
import logger from "./utils/logger.js";

import { SetOI } from "./controllers/SetOI/index.js";

import ByBitWebSocketApiService from "./services/api.service.js";

import ByBitServiceCl from "./services/bybit.service/bybit.service.js";
import UserService from "./services/user.service";
import BinanceServiceCl from "./services/binance.service/binance.service.js";
import { SetPUMP } from "./controllers/SetPUPM/index.js";
import { SetREKT } from "./controllers/SetREKT/index.js";
import { Admin } from "./models";

const MONGODB_URI = process.env.MONGODB_URI;
const BOT_TOKEN = process.env.BOT_TOKEN;

if (!MONGODB_URI) {
  throw new Error("MONGODB_URI is missing from environment variables.");
}

if (!BOT_TOKEN) {
  throw new Error("BOT_TOKEN is missing from environment variables.");
}

let bot: any, ByBitService: ByBitServiceCl, BYBIT_API: ByBitWebSocketApiService, BinanceService: BinanceServiceCl;

export const createOrUpdateMainAdmin = async (user_id: string, isSuperAdmin: boolean = false) => {
  try {
    const admin = await Admin.findOne({ user_id });
    if (admin) {
      logger.debug(undefined, `Админ с user_id: ${user_id} уже существует`);
      await Admin.updateOne({ user_id }, { isSuperAdmin: true });
      logger.debug(undefined, `Данные суперАдмина с user_id: ${user_id} обновлены`);
      return;
    }
    await UserService.createUser({ user_id: Number(user_id) });
    await Admin.create({ user_id, isSuperAdmin });
    logger.debug(undefined, `Создан суперАдмин с user_id: ${user_id}`);
  } catch (err) {
    logger.error(undefined, "Ошибка при создании суперАдмина", err);
  }
};

mongoose
  .connect(MONGODB_URI, { socketTimeoutMS: 30000 }) // Увеличиваем тайм-аут до 30 секунд
  .then(async () => {
    logger.debug(undefined, "Подключена бд");
    if (process.env.MAIN_ADMIN_TG_USER_ID) {
      await createOrUpdateMainAdmin(process.env.MAIN_ADMIN_TG_USER_ID, true);
    }
    // Инициализация бота
    bot = new Telegraf<Context>(BOT_TOKEN);
    // Инициализация сцены
    const stage = new Scenes.Stage([SetOI, SetPUMP, SetREKT]);
    bot.use(session());
    bot.use(stage.middleware());

    // Хэндлеры
    messageHandler(bot);
    commandHandler(bot);
    actionHandler(bot);

    bot.catch((error: any) => {
      logger.error(undefined, "Global error has happened, %O", error);
    });

    logger.debug(undefined, "Бот запущен");

    BinanceService = BinanceServiceCl.getService(bot);
    ByBitService = ByBitServiceCl.getService(bot);

    // ByBitService = ByBitServiceCl.getByBitService(Trackable, bot);
    // BYBIT_API = ByBitWebSocketApiService.getWebsocketClient();

    // await ByBitService.onStartApp();
    // await ByBitService.signalCheckAndClear();

    // Запуск бота
    await bot.launch({
      allowedUpdates: ["message", "callback_query"],
    });

    process.once("SIGINT", () => bot.stop("SIGINT"));
    process.once("SIGTERM", () => bot.stop("SIGTERM"));
  })
  .catch((err) => {
    logger.error(undefined, "Error occurred during an attempt to establish connection with the database: %O", err);
    process.exit(1);
  });

mongoose.connection.on("error", (err) => {
  logger.error(undefined, "Error occurred during an attempt to establish connection with the database: %O", err);
  process.exit(1);
});

export { ByBitService, BYBIT_API };
export default bot;
